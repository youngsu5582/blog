<!doctype html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="oom killer, heap memory, heapdump" /><meta name="author" content="이영수" /><meta property="og:locale" content="ko" /><meta name="description" content="헬로우 월드 프로젝트를 통해 OOM Killer와 메모리 관리에 대해 탐구하였다. Java로 메모리 부족을 유발하는 코드를 작성하고, OOM Killer의 작동 원리와 메모리 제한 설정 방법도 살펴보았다. 또한, 힙 메모리를 관리하며 GC와 관련된 다양한 옵션을 실험하였다. 이를 통해 서버 개발시 메모리 문제의 중요성을 깨닫게 되었다." /><meta property="og:description" content="헬로우 월드 프로젝트를 통해 OOM Killer와 메모리 관리에 대해 탐구하였다. Java로 메모리 부족을 유발하는 코드를 작성하고, OOM Killer의 작동 원리와 메모리 제한 설정 방법도 살펴보았다. 또한, 힙 메모리를 관리하며 GC와 관련된 다양한 옵션을 실험하였다. 이를 통해 서버 개발시 메모리 문제의 중요성을 깨닫게 되었다." /><link rel="canonical" href="https://youngsu5582.life//posts/oom-killer,-heap-memory,-heapdump/" /><meta property="og:url" content="https://youngsu5582.life//posts/oom-killer,-heap-memory,-heapdump/" /><meta property="og:site_name" content="이영수 개발 블로그" /><meta property="og:image" content="https://youngsu5582.life//assets/img/thumbnail/2025-04-19-oom killer, heap memory, heapdump.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-04-20T02:32:24+09:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://youngsu5582.life//assets/img/thumbnail/2025-04-19-oom killer, heap memory, heapdump.png" /><meta property="twitter:title" content="oom killer, heap memory, heapdump" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"이영수"},"dateModified":"2025-04-20T02:32:24+09:00","datePublished":"2025-04-20T02:32:24+09:00","description":"헬로우 월드 프로젝트를 통해 OOM Killer와 메모리 관리에 대해 탐구하였다. Java로 메모리 부족을 유발하는 코드를 작성하고, OOM Killer의 작동 원리와 메모리 제한 설정 방법도 살펴보았다. 또한, 힙 메모리를 관리하며 GC와 관련된 다양한 옵션을 실험하였다. 이를 통해 서버 개발시 메모리 문제의 중요성을 깨닫게 되었다.","headline":"oom killer, heap memory, heapdump","image":"https://youngsu5582.life//assets/img/thumbnail/2025-04-19-oom killer, heap memory, heapdump.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://youngsu5582.life//posts/oom-killer,-heap-memory,-heapdump/"},"url":"https://youngsu5582.life//posts/oom-killer,-heap-memory,-heapdump/"}</script><title>oom killer, heap memory, heapdump | 이영수 개발 블로그</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="이영수 개발 블로그"><meta name="application-name" content="이영수 개발 블로그"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GDSPGC31HX"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-GDSPGC31HX'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">이영수 개발 블로그</a><p class="site-subtitle fst-italic mb-0">Learning Kata</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/articles/" class="nav-link"> <i class="fa-fw "></i> <span>ARTICLES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/youngsu5582" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['joyson5582','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/%EC%98%81%EC%88%98-%EC%9D%B4-b78498347/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://www.rallit.com/hub/resumes/988543/%EC%9D%B4%EC%98%81%EC%88%98" aria-label="resume" target="_blank" rel="noopener noreferrer" > <i class="fas fa-file-alt"></i> </a> <a href="https://comet-pram-809.notion.site/185365707b6580859ec5ec052f2f6730" aria-label="portfolio" target="_blank" rel="noopener noreferrer" > <i class="fas fa-laptop-code"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>oom killer, heap memory, heapdump</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>oom killer, heap memory, heapdump</h1><p class="post-desc fw-light mb-4">헬로우 월드 프로젝트를 통해 OOM Killer와 메모리 관리에 대해 탐구하였다. Java로 메모리 부족을 유발하는 코드를 작성하고, OOM Killer의 작동 원리와 메모리 제한 설정 방법도 살펴보았다. 또한, 힙 메모리를 관리하며 GC와 관련된 다양한 옵션을 실험하였다. 이를 통해 서버 개발시 메모리 문제의 중요성을 깨닫게 되었다.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1745083944" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Apr 20, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/thumbnail/2025-04-19-oom killer, heap memory, heapdump.png" class="popup img-link preview-img shimmer"><img src="/assets/img/thumbnail/2025-04-19-oom killer, heap memory, heapdump.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2228 words" > <em>12 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">oom killer, heap memory, heapdump</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">oom killer, heap memory, heapdump</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog> <br><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/jvm/" class="post-tag no-text-decoration" >jvm</a> <a href="/tags/oom-killer/" class="post-tag no-text-decoration" >oom-killer</a> <a href="/tags/heamdump/" class="post-tag no-text-decoration" >heamdump</a></div><div class="content"><p>헬로우 월드 프로젝트를 진행하며 얕게나마 탐구한 부분이 있어서 오랜만에 블로그에 정리한다.</p><h2 id="killed-process-in-container"><span class="me-2">killed process in container</span><a href="#killed-process-in-container" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>의도적으로 OOM 을 발생시키는 아래와 같은 로직이 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>  
<span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>  
  
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/oom"</span><span class="o">)</span>  
<span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">causeOom</span><span class="o">()</span> <span class="o">{</span>  
    <span class="c1">// 100MB  </span>
    <span class="kd">final</span> <span class="kt">var</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">createSize</span><span class="o">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">100</span><span class="o">);</span>  
    <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(),</span> <span class="n">bytes</span><span class="o">);</span>  
    <span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span>  
        <span class="nc">Map</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>  
            <span class="s">"Total Memory"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()),</span>  
            <span class="s">"Max Memory"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">maxMemory</span><span class="o">()),</span>  
            <span class="s">"Free Memory"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">()),</span>  
            <span class="s">"Used Memory"</span><span class="o">,</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">-</span> <span class="nc">Runtime</span>  
                <span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">())</span>  
        <span class="o">)</span>  
    <span class="o">);</span>  
<span class="o">}</span>
</pre></table></code></div></div><ul><li>한번 요청시, 100MB 씩 힙 메모리에 쌓인다.<li>메모리 관련 매트릭 정보를 응답한다.</ul><div class="language-yml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="na">deploy</span><span class="pi">:</span>  
  <span class="na">resources</span><span class="pi">:</span>  
    <span class="na">limits</span><span class="pi">:</span>  
      <span class="na">memory</span><span class="pi">:</span> <span class="s">2G</span>
</pre></table></code></div></div><p>deploy 설정을 통해 의도적으로 컨테이너의 메모리를 2G로 제한했다.</p><p><code class="language-plaintext highlighter-rouge">java -Dserver.port=8080 -Xmx2048m -Xmx2048m app.jar</code></p><p>로 서버를 실행시키고 20번을 요청을 보내려고 하던 도중</p><p><code class="language-plaintext highlighter-rouge">Killed</code> 와 함께 서버가 죽었다.</p><blockquote><p>컨테이너가 죽는게 아니고, 왜 애플리케이션이 꺼지지..?</p></blockquote><p>이와같은 처리는 OOM Killer 라는 요소 때문에 동작한다.</p><h3 id="oom-killer"><span class="me-2">OOM Killer</span><a href="#oom-killer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>컨테이너들은 cgroup 을 통해 사용할 수 있는 메모리를 제한한다. cgroup 이 운영체제 레벨에서 지정된 메모리 까지 도달했는지 ( 메모리 부족 상황 ) 상황을 감지한다. → 도달했다면 Linux 내부에는 OOM Killer 라는게 프로세스를 죽인다.</p><blockquote><p>서버를 자기 멋대로 killed 하는게 너무 별로 같은데?</p></blockquote><p>컨테이너를 설정할때 설정할 수 있는 방법이 있다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>oom_kill_disable: true
oom_score_adj: -1000
</pre></table></code></div></div><p>프로세스가 죽지 않게 하기 위해 OOM Killer 를 Disable 을 할 순 있다.</p><p>하지만, 이렇게 하면 절대 안된다.</p><p>→ 메모리를 꽉 차지 하고 있는 프로세스가 종료되지 않으므로 컨테이너가 사실상 멈추게 된다.</p><p><code class="language-plaintext highlighter-rouge">bash: start_pipeline: pgrp pipe: Too many open files in system</code></p><p>와 같이 뜨고 모든 요청들을 처리하지 않는다. ( 웹 요청 뿐 아니라, 리눅스 커맨드 등등 전부 )</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>nginx    | 172.18.0.1 - - [16/Apr/2025:04:08:53 +0000] "GET /actuator/prometheus HTTP/1.1" 499 0 "-" "Prometheus/2.45.1" "-"
nginx    | 2025/04/16 04:08:53 [crit] 30#30: accept4() failed (23: Too many open files in system)
nginx    | 2025/04/16 04:08:54 [alert] 30#30: epoll_ctl(1, 7) failed (12: Cannot allocate memory)
</pre></table></code></div></div><p>그렇기에 무조건 Java 최대 힙 메모리도 걸고 만약에도 OOM Killer 를 통해서 프로세스가 컨테이너(인스턴스) 를 파괴하지 않게 해줘야 한다.</p><p><a href="https://blog.2dal.com/2017/03/27/docker-and-oom-killer/">참고</a></p><p>실제 메모리를 할당해주는게 아닌 메모리를 프로세스에게 할당해준 것 처럼 체크한다. - Memory Commit -&gt; 메모리보다 더 많이 할당받는 일종의 Over Commit 이 발생할 수도 있다.</p><p>실제 사용하는 메모리를 over 하지 않으면 메모리 부족 에러 및 kill이 발생하지 않을수도 있다. ( 100% 넘기면 OOM-killer 사용해 조건의 프로세스 죽여서 확보 )</p><h2 id="xms-와-commited-memory-상관관계"><span class="me-2">Xms 와 Commited Memory 상관관계</span><a href="#xms-와-commited-memory-상관관계" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>JVM 을 구동할 때 Xms,Xmx 는 최소 점유할 / 최대 점유할 메모리의 양을 정하는 옵션이다.</p><blockquote><p><code class="language-plaintext highlighter-rouge">X</code> 옵션은 Non-Standard Option으로 Macro 한 측면 튜닝을 한다.</p></blockquote><p>JVM 은 현재 할당된 메모리(Committed Memory) 가 부족하다고 느끼면 OS에게 요청해서 물리 페이지를 추가로 할당받는다. -&gt; 할당(Committed)에 실패하면 OOM 예외가 발생하게 되는것</p><p>그러면 메모리 사용량이 감소하면, Committed Memory 도 이에 맞게 감소가 될까?</p><p>우선, 정답부터 말하면 해제된 메모리 역시도 힙의 일부로 남게 된다.</p><p><a href="https://i.imgur.com/muySY3X.png" class="popup img-link shimmer"><img src="https://i.imgur.com/muySY3X.png" alt="" loading="lazy"></a></p><p>아래와 같은 내용을 본적이 있어서 <code class="language-plaintext highlighter-rouge">왜 계속 반환이 안되는거지?</code> 라는 호기심이 계속 있었다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>- G1 GC 는 힙 사이즈를 조정하고 해제된 메모리를 OS에 반환한다. - JEP 346
- ZGC 는 사용하지 않는 메모리 OS에 반환 - JEP 351
</pre></table></code></div></div><p>Committed Memory 를 OS 에 return 하는 설정은 기본적으로 비활성화 되어있다. ( 내가 확인한 바로는 )</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>-XX:G1PeriodicGCInterval=5000 (5초) 등으로 설정하여 주기적으로 Idle GC를 트리거합니다.
// 기본은 0 ( 주기적 GC 비활성화, GC가 필요하다고 판단 될 때만 활성화 되게 )
-XX:G1PeriodicGCSystemLoadThreshold=0 (유휴 상태 관련 로드 임계값 설정)
// 기본값도 0 
-XX:G1PeriodicGCInvokesConcurrent (Concurrent GC로 진행할지, Full GC로 진행할지)
// 기본은 false ( FULL GC )
</pre></table></code></div></div><p>이와같은 이유는 매번 해제 후 OS와 상호작용 해 메모리 반환하는 게 CPU 자원을 많이 소모시키기 때문이다.</p><blockquote><p>많은 프로덕션 환경에서는 애플리케이션 성능과 예측 가능한 GC pause를 위해 힙 크기를 일정하게 유지하는 것이 중요함 (주기적 힙 축소가 오히려 자주 GC 유도하고 불필요한 GC Pause 발생시킬 위험이 존재한다. )</p></blockquote><p><code class="language-plaintext highlighter-rouge">java -Xms512m -Xmx1024m -XX:G1PeriodicGCInterval=5000 -jar app.jar</code></p><p><a href="https://i.imgur.com/1JntkQy.png" class="popup img-link shimmer"><img src="https://i.imgur.com/1JntkQy.png" alt="" loading="lazy"></a></p><p>주기적인 GC 가 일어나고 바로 committed memory 도 감소시킨다. ( System.gc 와 같이 의도적 GC 호출시에도 바로 반환 )</p><blockquote><p>이때, 나는 의도적으로 OOM 을 발생시키고, 제대로 반환이루어 지는지를 확인한 것이다. 혹시나, 다른 상황 및 설정에선 내가 정리한 내용들과 다를 수 있다. ( 직접 확인 )</p></blockquote><h3 id="heap-dump"><span class="me-2">Heap Dump</span><a href="#heap-dump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Commited Memory 가 감소하지 않길래 왜 그런지를 확인하기 위해 힙 덤프까지 내려갔다.</p><blockquote><p>Used Memory 도 바로 안 내려가길래 겸사겸사 한건데 기다리니 내려가더라. 🥲</p></blockquote><blockquote><p><code class="language-plaintext highlighter-rouge">jmap -dump:live</code> dump live 를 하면, 명시적 GC가 일어나 Committed Memroy 도 반환</p></blockquote><p><code class="language-plaintext highlighter-rouge">jmap -dump:live,format=b,file=heapdump.hprof &lt;pid&gt;</code></p><p><code class="language-plaintext highlighter-rouge">-dump</code> : dump 따라는 명령어 <code class="language-plaintext highlighter-rouge">live</code> : 살아있는 객체만 덤프 ( GC를 수행해 살아있는 객체만 덤프 ) <code class="language-plaintext highlighter-rouge">format</code> : 바이너리만 지원 <code class="language-plaintext highlighter-rouge">file</code> : 파일명 지정</p><p>힙덤프를 따서 확인해보면 ( IDEA 에서 기본 제공된 요소들로 확인했다. - Profiler )</p><p>힙덤프 메인화면 좌측에는 <code class="language-plaintext highlighter-rouge">Count, Shallow, Retained</code> 라는 요소들이 있다.</p><p><a href="https://i.imgur.com/YWGLzuQ.png" class="popup img-link shimmer"><img src="https://i.imgur.com/YWGLzuQ.png" alt="" loading="lazy"></a></p><ul><li>Count : 해당 클래스 타입 인스턴스가 몇 개 존재하는지 나탄냄<li>Shallow : 개별 객체가 차지하는 메모리 크기 ( 어떤 객체가 자기 자신만을 저장하기 위해소모하는 힙 메모리 - 배열 전체 크기 )<li>Retained : 객체가 유지하고 있는 전체 메모리 크기 ( 객체가 GC 로부터 더 이상 참조되지 않는다고 가정하면, 함께 정리할 수 있는 모든 객체 Shallow size 합 )</ul><blockquote><p><code class="language-plaintext highlighter-rouge">Node[]</code>는 버킷 배열 인스턴스, <code class="language-plaintext highlighter-rouge">Node</code> 는 체이닝된 노드</p></blockquote><p>궁금한 객체를 더블클릭하면 우측 화면이 바뀐다.</p><p><a href="https://i.imgur.com/GPHUxfx.png" class="popup img-link shimmer"><img src="https://i.imgur.com/GPHUxfx.png" alt="" loading="lazy"></a></p><p>Dominators 를 통해 어떤 객체가 어떤 요소를 지배하는지 볼 수 있다. ( byte를 Node가, Node를 Node<code class="language-plaintext highlighter-rouge">[]</code>를 … )</p><p>힙덤프 메인화면 우측에는 <code class="language-plaintext highlighter-rouge">Biggest Objects</code>, <code class="language-plaintext highlighter-rouge">Summary</code>, <code class="language-plaintext highlighter-rouge">Packages</code> 등 유용한 정보들이 있다.</p><ul><li>Biggest Objects : 가장 큰 객체<li>Summary : 힙 메모리 크기, 스레드 상태 등 정보<li>Packages : 패키지당 힙 메모리 차지 크기</ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/clear"</span><span class="o">)</span>  
<span class="kd">public</span> <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>  
    <span class="n">map</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
    <span class="o">...</span>
<span class="o">}</span>
</pre></table></code></div></div><p>map 을 clear 해서 배열 참조를 끊으면?</p><p><a href="https://i.imgur.com/pBoec0y.png" class="popup img-link shimmer"><img src="https://i.imgur.com/pBoec0y.png" alt="" loading="lazy"></a></p><p>Map Value 에 있는 byte 배열은 유지하는 크기가 사라져서 GC 대상이 된다.</p><p><a href="https://i.imgur.com/NoaImAL.png" class="popup img-link shimmer"><img src="https://i.imgur.com/NoaImAL.png" alt="" loading="lazy"></a></p><p>시간이 지나면, 사용중인 ( Used ) 메모리가 감소한다. ( Committed Memory 는 감소 X )</p><h2 id="결론"><span class="me-2">결론</span><a href="#결론" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>사실, <code class="language-plaintext highlighter-rouge">우리 서버는 절대 OOM 발생할 일 없어</code> 라고 생각해서 쳐다보지 않은 영역 이였다. ( 사이드 프로젝트건, 간단한 팀 프로젝트건 결국 처음부터 시작이니 )</p><p>힙 덤프 역시도 자세히 보지 않았는데 보면서 왜 서버에 문제가 나면 힙 덤프를 봐야하는지도 조금 깨달았다.</p><ul><li>어떤 라이브러리를 사용해서 병목이 될 수 있음 - <a href="https://techblog.woowahan.com/2628/">도움이 될수도 있는 JVM memory leak 이야기</a><li>어떤 로직이 빨리 처리되지 못해 FULL GC로 넘어감<li>어떤 클래스를 가지고 있는 상위 클래스들 파악<li>스레드가 BLOCK 되는지</ul><p>등등</p><p>결국, 멋진 서버 개발자가 되기 위해선 기초 돌다리부터 천천히 다져나가야 하는거 같다.</p></div><div class="post-tail-wrapper text-muted"><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=oom%20killer,%20heap%20memory,%20heapdump%20-%20%EC%9D%B4%EC%98%81%EC%88%98%20%EA%B0%9C%EB%B0%9C%20%EB%B8%94%EB%A1%9C%EA%B7%B8&url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2Foom-killer%2C-heap-memory%2C-heapdump%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2Foom-killer%2C-heap-memory%2C-heapdump%2F&text=oom%20killer,%20heap%20memory,%20heapdump%20-%20%EC%9D%B4%EC%98%81%EC%88%98%20%EA%B0%9C%EB%B0%9C%20%EB%B8%94%EB%A1%9C%EA%B7%B8" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2Foom-killer%2C-heap-memory%2C-heapdump%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/%EA%B0%9C%EB%B0%9C%EC%9E%90%EB%9D%BC%EB%A9%B4-%EA%BC%AD-%EC%95%8C%EC%95%84%EC%95%BC-%ED%95%A0-AI-%EA%B8%B0%EC%88%A0-%ED%99%9C%EC%9A%A9%EB%B2%95-%EC%98%81%EC%83%81%EC%97%90-%EB%8C%80%ED%95%9C-%EC%A0%95%EB%A6%AC-%EB%B0%8F-%EA%B0%84%EB%8B%A8%ED%95%9C-%EC%82%AC%EB%8B%B4/">개발자라면 꼭 알아야 할 AI 기술 활용법 영상 정리 및 간단한 사담 - 2025-08-20</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-Jackson-%EC%84%A4%EC%A0%95%EB%93%A4-%EC%A0%95%EB%A6%AC/">사용하는 Jackson의 설정 및 기능 정리 - 2025-06-17</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%98%88%EC%99%B8-%EA%B9%8A%EA%B2%8C-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0-%EC%98%88%EC%99%B8-%EB%8F%99%EC%A0%81%EC%9C%BC%EB%A1%9C-%EB%8D%98%EC%A7%80%EA%B8%B0/">예외 깊게 살펴보기, 예외 동적으로 던지기 - 2025-05-31</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-ENUM-%EA%B0%92-%EB%8C%80%EC%9D%91,Interface-%ED%86%B5%ED%95%9C-%EC%A4%91%EB%B3%B5-%EC%BD%94%EB%93%9C-%EC%A0%9C%EA%B1%B0/">사용하지 않는 ENUM 값 대응 , Interface 를 통한 중복 코드 제거 - 2025-05-26</a><li class="text-truncate lh-lg"> <a href="/posts/oom-killer,-heap-memory,-heapdump/">oom killer, heap memory, heapdump - 2025-04-20</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9A%B0%ED%85%8C%EC%BD%94/">우테코</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81/">스프링</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%9A%8C%EA%B3%A0/">회고</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83%ED%97%88%EB%B8%8C/">깃허브</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9E%90%EB%B0%94/">자바</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83/">깃</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%BD%94%ED%8B%80%EB%A6%B0/">코틀린</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%85%8C%EC%8A%A4%ED%8A%B8/">테스트</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/%EB%8F%88%EC%9C%BC%EB%A1%9C-%EC%8B%9C%EA%B0%84-%EC%82%AC%EA%B8%B0/" class="btn btn-outline-primary" aria-label="Older" ><p>돈으로 시간을 사기 - 부제 : openai 통한 게시글 소개글 및 섬네일 자동 생성 스크립트</p></a> <a href="/posts/%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-ENUM-%EA%B0%92-%EB%8C%80%EC%9D%91,Interface-%ED%86%B5%ED%95%9C-%EC%A4%91%EB%B3%B5-%EC%BD%94%EB%93%9C-%EC%A0%9C%EA%B1%B0/" class="btn btn-outline-primary" aria-label="Newer" ><p>사용하지 않는 ENUM 값 대응 , Interface 를 통한 중복 코드 제거</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/youngsu5582">이영수</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9A%B0%ED%85%8C%EC%BD%94/">우테코</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81/">스프링</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%9A%8C%EA%B3%A0/">회고</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83%ED%97%88%EB%B8%8C/">깃허브</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9E%90%EB%B0%94/">자바</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83/">깃</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%BD%94%ED%8B%80%EB%A6%B0/">코틀린</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%85%8C%EC%8A%A4%ED%8A%B8/">테스트</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'en';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'youngsu5582/blog', 'data-repo-id': 'R_kgDOOI2eig', 'data-category': 'Post', 'data-category-id': 'DIC_kwDOOI2eis4Cob3Y', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
