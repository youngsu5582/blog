<!doctype html><html lang="ko" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="스레드,스레드풀 in Java" /><meta name="author" content="이영수" /><meta property="og:locale" content="ko" /><meta name="description" content="왜 여러개의 스레드 풀이 하나의 스레드 풀보다 좋은가" /><meta property="og:description" content="왜 여러개의 스레드 풀이 하나의 스레드 풀보다 좋은가" /><link rel="canonical" href="https://youngsu5582.life//posts/%EC%8A%A4%EB%A0%88%EB%93%9C%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80-in-Java/" /><meta property="og:url" content="https://youngsu5582.life//posts/%EC%8A%A4%EB%A0%88%EB%93%9C%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80-in-Java/" /><meta property="og:site_name" content="이영수 개발 블로그" /><meta property="og:image" content="https://velog.velcdn.com/images/dragonsu/post/79c55bba-2e1b-42ca-a175-773ff9480ae6/image.jpeg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2025-01-17T12:02:53+09:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://velog.velcdn.com/images/dragonsu/post/79c55bba-2e1b-42ca-a175-773ff9480ae6/image.jpeg" /><meta property="twitter:title" content="스레드,스레드풀 in Java" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"이영수"},"dateModified":"2025-01-17T12:02:53+09:00","datePublished":"2025-01-17T12:02:53+09:00","description":"왜 여러개의 스레드 풀이 하나의 스레드 풀보다 좋은가","headline":"스레드,스레드풀 in Java","image":"https://velog.velcdn.com/images/dragonsu/post/79c55bba-2e1b-42ca-a175-773ff9480ae6/image.jpeg","mainEntityOfPage":{"@type":"WebPage","@id":"https://youngsu5582.life//posts/%EC%8A%A4%EB%A0%88%EB%93%9C%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80-in-Java/"},"url":"https://youngsu5582.life//posts/%EC%8A%A4%EB%A0%88%EB%93%9C%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80-in-Java/"}</script><title>스레드,스레드풀 in Java | 이영수 개발 블로그</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="이영수 개발 블로그"><meta name="application-name" content="이영수 개발 블로그"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/ko.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GDSPGC31HX"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-GDSPGC31HX'); }); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">이영수 개발 블로그</a><p class="site-subtitle fst-italic mb-0">Learning Kata</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span></span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/articles/" class="nav-link"> <i class="fa-fw "></i> <span>ARTICLES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/youngsu5582" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['joyson5582','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/%EC%98%81%EC%88%98-%EC%9D%B4-b78498347/" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://www.rallit.com/hub/resumes/988543/%EC%9D%B4%EC%98%81%EC%88%98" aria-label="resume" target="_blank" rel="noopener noreferrer" > <i class="fas fa-file-alt"></i> </a> <a href="https://comet-pram-809.notion.site/185365707b6580859ec5ec052f2f6730" aria-label="portfolio" target="_blank" rel="noopener noreferrer" > <i class="fas fa-laptop-code"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"></a> </span> <span>스레드,스레드풀 in Java</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button><style> .language-switcher { display: flex; gap: 10px; list-style: none; margin: 0; padding: 0; } .language-switcher li a { padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; text-decoration: none; color: #333; background-color: #f0f0f0; } .language-switcher li a:hover { background-color: #e0e0e0; } .language-switcher li .active-lang { /* 현재 활성화된 언어 텍스트 스타일 */ padding: 5px 10px; border: 1px solid #007bff; border-radius: 5px; color: white; background-color: #007bff; cursor: default; }</style><ul class="language-switcher"><li> <span class="active-lang">한국어</span><li> <a href="https://youngsu5582.life//en/">English</a></ul><search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel"></button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>스레드,스레드풀 in Java</h1><p class="post-desc fw-light mb-4">왜 여러개의 스레드 풀이 하나의 스레드 풀보다 좋은가</p><div class="post-meta text-muted"> <span> <time data-ts="1737082973" data-df="DD/MM/YYYY" data-bs-toggle="tooltip" data-bs-placement="bottom" > 17/01/2025 </time> </span><div class="mt-3 mb-3"> <a href="https://velog.velcdn.com/images/dragonsu/post/79c55bba-2e1b-42ca-a175-773ff9480ae6/image.jpeg" class="popup img-link preview-img shimmer"><img src="https://velog.velcdn.com/images/dragonsu/post/79c55bba-2e1b-42ca-a175-773ff9480ae6/image.jpeg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="8152 " > <em>45 </em> </span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">스레드,스레드풀 in Java</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1"></span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">스레드,스레드풀 in Java</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog> <br><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/%EB%B0%B1%EC%97%94%EB%93%9C/">백엔드</a>, <a href="/categories/%EC%9E%90%EB%B0%94/">자바</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/%EC%8A%A4%EB%A0%88%EB%93%9C/" class="post-tag no-text-decoration" >스레드</a> <a href="/tags/%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80/" class="post-tag no-text-decoration" >스레드풀</a> <a href="/tags/%EC%9A%B0%ED%85%8C%EC%BD%94/" class="post-tag no-text-decoration" >우테코</a></div><div class="content"><blockquote><p>해당 내용은 <code class="language-plaintext highlighter-rouge">왜 여러개의 스레드 풀이 필요한가?</code> 를 고민하며 다룬 내용입니다. 실제 테스트를 하며 작성한 내용이라 틀린 부분이 있을수 있습니다. 틀린 부분이 있다면 <code class="language-plaintext highlighter-rouge">joyson5582@gmail.com</code> 이나 댓글로 남겨주세요 🙂</p></blockquote><blockquote><p>자바에서 스레드와 스레드풀을 정리하기 전 O.S 에서 스레드는 어떻게 동작을 하는지 알아보고 시작을 한다. 그래야, 자바에서 어떻게 현명하게 스레드와 스레드풀을 관리 및 사용할지 알기 쉽기 떄문이다.</p></blockquote><blockquote><p>개념에 대한 자세한 내용 및 설명은 다루지 않습니다.</p></blockquote><h1 id="스레드-in-os">스레드 in O.S</h1><p>흔히 자주 들어봤을것이다. 스레드는 프로세스 내 존재하는 일꾼들 그러면 이 스레드가 어떻게 우리의 프로그램 내에서 잘 동작할까</p><h2 id="하드웨어-스레드"><span class="me-2">하드웨어 스레드</span><a href="#하드웨어-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>컴퓨터는 코어를 가지고 있다. 이 코어는 프로그램의 명령어를 처리하고 계산을 수행하는 역할을 한다. 코어는 4개,8개 16개 등 매우 적은 숫자이므로 매우매우 빠르게 효율적으로 처리가 되어야 한다.</p><p>코어의 고민 : 메모리에서 데이터를 기다리는 시간이 꽤 오래 걸린다. ( 메모리와 관련된 작업을 하는동안 코어가 쉬게되므로 )</p><p>-&gt; 메모리에 접근하는 공간마다 다른 작업을 수행하게 하자! =&gt; 서로 다른 스레드를 실행해 시간을 낭비하지 않게 하자.</p><p>이게 하드웨어 스레드이다.</p><h4 id="-threading-in-intel--물리적인-코어마다-하드웨어-스레드가-두개-배치"><span class="me-2">-threading in Intel : 물리적인 코어마다 하드웨어 스레드가 두개 배치</span><a href="#-threading-in-intel--물리적인-코어마다-하드웨어-스레드가-두개-배치" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><ul><li>O.S 관점에서 가상의 코어<blockquote><p>싱글 코어 CPU 에 하드웨어 스레드가 두개라면? -&gt; O.S 는 이 CPU 를 듀얼 코어로 인식해 듀얼 코어에 맞게 O.S 레벨 스레드 스케줄링을 한다.</p></blockquote></ul><h2 id="커널-os-스레드"><span class="me-2">커널, O.S 스레드</span><a href="#커널-os-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="커널이란"><span class="me-2">커널이란?</span><a href="#커널이란" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>운영체제의 핵심이다. 리눅스에 한정되는게 아닌 윈도우,IOS,리눅스 등 모두에게 적용되는 용어이다.</p><ul><li>시스템 전반을 관리 / 감독하는 역할<li>하드웨어와 관련된 작업을 직접 수행</ul><p>( 하단 <code class="language-plaintext highlighter-rouge">유저 스레드</code> 부분에서 커널이 왜 필요한지 조금 더 설명한다. )</p><h3 id="os-스레드"><span class="me-2">O.S 스레드</span><a href="#os-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>커널 레벨에서 생성되고 관리되는 스레드 ( CPU 에서 실제 실행되는 단위, CPU 스케줄링의 단위가 O.S 스레드 )</p><ul><li>O.S 스레드 컨텍스트 스위칭은 커널이 개입한다 -&gt; 비용 발생<li>사용자 코드, 커널 코드 모두 O.S 스레드 단 실행</ul><p>우리가 작성한 코드에서, <code class="language-plaintext highlighter-rouge">System Call</code> 같은 요소들을 사용하면? -&gt; 커널 코드를 OS Thread 가 실행한다. -&gt; 다시 유저 모드로 돌아와서, 우리가 작성한 코드가 실행된다.</p><blockquote><p>아래와 같이 불리기도 한다. 네티이브 스레드 커널 스레드 ( 맥락에 따라 다른 의미로 사용될 수 있다. O.S 커널의 역할을 수행하는 스레드 ) 커널-레벨 스레드 OS-레벨 스레드</p></blockquote><h3 id="유저-스레드"><span class="me-2">유저 스레드</span><a href="#유저-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><code class="language-plaintext highlighter-rouge">User Program</code> 과 관련 ( Java, Python, Go… ) <code class="language-plaintext highlighter-rouge">유저-레벨 스레드</code> 라고 불린다.</p><p>스레드 개념을 프로그래밍 레벨에서 추상화한 것이다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">();</span>
<span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</pre></table></code></div></div><p>와 같이, 프로그래밍 언어에서 제공해준다. <code class="language-plaintext highlighter-rouge">thread.start</code> 를 좀 더 살펴보면</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">threadStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalThreadStateException</span><span class="o">();</span>

        <span class="n">group</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>

        <span class="kt">boolean</span> <span class="n">started</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">start0</span><span class="o">();</span>
            <span class="n">started</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">started</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">group</span><span class="o">.</span><span class="na">threadStartFailed</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ignore</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
<span class="kd">private</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">start0</span><span class="o">();</span>
</pre></table></code></div></div><p>start0은 JNI 를 통해 O.S 의 System Call 을 호출한다. -&gt; Clone 이라는 시스템을 호출해 O.S 레벨의 스레드를 하나 생성 ( in Linux ) -&gt; O.S 레벨 스레드가 자바의 유저 스레드와 연결이 된다.</p><ul><li>유저 스레드가 CPU 에서 실행 되려면, O.S 스레드와 반드시 연결이 되어야 한다. ( 아래 Model 에서 좀 더 설명 )</ul><blockquote><p>System Call 을 호출하면 User Mode -&gt; Kernel Mode 로 전환된다.</p><ol><li>프로그램 현재 CPU 상태 저장<li>커널이 인터럽트나 시스템 콜 직접 처리 ( CPU 가 커널 코드 실행 )<li>처리가 완료되면 중단된 프로그램의 CPU 상태 복원 통제권을 반환해 Kernel Mode -&gt; User Mode 로 전환된다.</ol></blockquote><blockquote><p>시스템 전반적인 부분을 보호하기 위해 ( 하드웨어 함부로 정의 및 전체 시스템 붕괴 등을 불러올 수 있으므로 )</p></blockquote><ul><li>Interrupt : 시스템에서 발생한 다양한 종류 이벤트 혹은 이벤트 알려주는 메커니즘</ul><p>I/O 작업 완료, 시간이 다 됐을 때(time), 0으로 나눌 때, 잘못된 메모리 공간 접근 등등 ( Java 에선, <code class="language-plaintext highlighter-rouge">InterruptedException</code> 이 존재한다. ) -&gt; CPU 가 즉각적으로 인터럽트 처리 위해 커널 코드를 커널 모드에서 실행한다.</p><ul><li>System Call : 프로그램이 OS 커널이 제공하는 서비스 이용하고 싶을 때 사용</ul><p>프로세스/스레드, 파일 I/O, 소켓 관련, 프로세스 통신 관련 등을 할 때 호출한다. 호출이 되면, 해당 커널 코드를 커널 모드에서 실행한다.</p><blockquote><p>CASE : 파일 READ 작업 파일 읽기 작업을 수행하는 t1, 다른 작업 수행하는 t2 가정</p><p>t1 이 Read 라는 System Call 을 호출해 커널 모드 진입한다.</p><ul><li>파일 읽을 때 까지 WAITING 상태로 바꾼다.<li>CPU 가 스케줄링을 통해 t2 를 READY -&gt; RUNNING 으로 바꿔 작동하게 한다. 커널 모드에서 유저 모드로 전환이 된다.</ul><p>t2 가 작업을 수행하는 도중, SSD(File System) 가 파일을 준비했다는 Interrupt 를 발생시킨다. Interrupt 를 처리하기 위해 커널 모드로 바꾼다. ( 기존 작업중인 t2 CPU 저장 )</p><ul><li>t1 을 WAITING -&gt; READY 으로 바꾼다. t2 CPU 를 복원하고, 다시 작업을 처리한다.</ul><p>Time Slice 를 통해 타어미가 주어진 시간을 다 썼다는 Interrupt 를 발생시킨다. Interrupt 를 처리하기 위해 커널 모드로 바꾼다. ( 기존 작업중인 t2 CPU 저장 )</p><ul><li>t1 이 READY -&gt; RUNNING 상태가 된다.<li>t2 는 READY 상태가 된다.</ul></blockquote><p>그러면 이런 유저 스레드는 어떻게 처리되고, 관리가 될까? 이는 프로그래밍 언어가 설계한 방법에 따라 다르다. 이를 <code class="language-plaintext highlighter-rouge">... Model</code> 이라고 한다.</p><h4 id="one-to-one-model"><span class="me-2">One-To-One Model</span><a href="#one-to-one-model" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>자바에서 사용하는 방법이다. ( 그러므로, O.S 스레드와 무조건 연결이 되어 있어야 한다고 설명한 것 ) 스레드 관리를 O.S 에 위임, 스케줄링도 커널이 수행한다. O.S가 처리하므로 멀티코어도 잘 활용한다.</p><ul><li>하나의 스레드가 BLOCK 이 되어도 다른 스레드들은 잘 동작한다. ( 1:1 관계이므로 ) -&gt; Race Condition 이 발생할 순 있다.</ul><h4 id="many-to-one-model"><span class="me-2">Many-To-One Model</span><a href="#many-to-one-model" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>유저 스레드 N개 : O.S 스레드 1개 코루틴과 연관있다. - 코루틴이 Many-To-One Model 은 아니나, 그렇게 사용될 수 있다.</p><ul><li>컨텍스트 스위칭이 더 빠름 ( 커널이 개입 X, 애플리케이션 단에서 스위칭 처리 )<li>O.S 레벨에서 Race Condition 이 발생할 가능성이 거의 없다. ( 유저 레벨에서 발생 )<li>멀티코어는 활용 못함 ( 하나만 활성화 되어 있는 상태이므로 )<li>O.S 스레드가 블락 되면, 모든 유저 스레드가 블락 된다. ( Non Blocking IO 가 나오게 된 이유 )</ul><h4 id="many-to-many-model"><span class="me-2">Many-To-Many Model</span><a href="#many-to-many-model" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>유저 스레드 N개 : O.S 스레드 N개</p><ul><li>위 두가지 모델의 장점을 합쳐서 만든 모델<li>O.S 스레드가 블락 되어도, 다른 O.S 스레드가 처리한다.<li>구현이 복잡하다. ( Go가 지원 )</ul><h4 id="그린-스레드"><span class="me-2">그린 스레드?</span><a href="#그린-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Java 초창기 버전에서 <code class="language-plaintext highlighter-rouge">Many-To-One</code> 스레딩 모델 사용했다고 한다. 이때, 유저 스레드들을 <code class="language-plaintext highlighter-rouge">그린 스레드</code> 라고 호칭했다.</p><p>계속 확장되어, 현재는 <code class="language-plaintext highlighter-rouge">OS 와 독립적으로 유저 레벨에서 스케줄링되는 스레드</code> 의 의미로도 사용된다. 참고만 하면 될 것 같다.</p><h3 id="멀티태스킹-️"><span class="me-2">멀티태스킹 ⭐️</span><a href="#멀티태스킹-️" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>해당 부분은 계속해서 중요하다. 왜, 스레드 풀이란게 필요한지에 대한 근본적인 접근일 수 있기 때문이다.</p></blockquote><p>CPU는 한 번에 하나의 프로세스 혹은 스레드만 실행될 수 있다는 제약이 있다. ( 우선, 싱글스레드로 가정 ) -&gt; 멀티태스킹을 통해 해결한다.</p><p>아주 짧은 CPU 시간을 할당해 주고, 시간 다 사용하면 다음 스레드가 실행되게 하는 방식 ( t1 -&gt; t2 -&gt; t3 -&gt; t1 -&gt; t2 -&gt; … )</p><p>동일하게 부여되는 CPU 시간을 <code class="language-plaintext highlighter-rouge">time slice</code> or <code class="language-plaintext highlighter-rouge">quantum</code> ( 몇 ~ 몇십 ms )</p><p>이 slice 는 고정이 아니다!</p><p>고정된 slice 라면? -&gt; 동시, 실행된 스레드 수가 늘어날수록 스레드가 실행되고 다시 자기 차례 올때가지 대기하는 시간이 길어진다. =&gt; 동시 실행되는 스레드 수에 따라 <code class="language-plaintext highlighter-rouge">time slice</code> 를 조정한다. ( CFS 스케줄러 )</p><blockquote><p>현재, 리눅스 6.6 부터 <code class="language-plaintext highlighter-rouge">eevdf</code> 라는 스케줄러로 교체가 되었다고 한다. https://www.reddit.com/r/linux_gaming/comments/17rohqp/linux_66_with_eevdf_the_new_cpu_scheduler_gaming/ CFS 는 공정성 중점, EEVDF 는 지연 시간 고려 -&gt; 복잡성을 제거하고, 지연 시간을 낮춘다. 해당 내용은 CFS 를 기반으로 설명한다. ( 큰 맥락 및 자바 - 스레드 풀 관점에서 깊게 다룰 내용은 아니므로 )</p></blockquote><ul><li>target latency : 작업이 CPU 할당받는 목표 시간<li>time slice : 작업이 진행되는 시간 ( Context Switching 이 일어나는 간격 )</ul><p>20ms + 작업 개수 4개 =&gt; time slice 는 5ms</p><p>스레드 수가 많아질수록 컨텍스트 스위칭이 빈번하게 일어난다. 추가로, <code class="language-plaintext highlighter-rouge">공유 자원</code> 에 대한 동기화가 필연적으로 발생하게 된다.</p><p>그러면 스레드가 많아질수록 안좋다는 건 알겠는데 이게 애플리케이션 단까지 적용이 될까? 이제 <code class="language-plaintext highlighter-rouge">스레드 in Java</code> 를 시작한다.</p><h1 id="스레드-in-java">스레드 in Java</h1><p>자바에서 스레드는 위에서 말한 것처럼 운영체제 단 스레드와 1:1 매핑된다. ( 운영 체제 스레드의 Wrapper )</p><blockquote><p><code class="language-plaintext highlighter-rouge">Virtual Thread</code> 관점에서 다루지 않는다. ( 아직, <code class="language-plaintext highlighter-rouge">캐리어 스레드</code> 단 피닝 발생 이슈 및 다양한 유스케이스가 없기 때문에 )</p></blockquote><p>그래서 Java 는 아래와 같은 특징을 가진다.</p><ul><li>스레드를 무제한 생성하면, 리소스가 매우 빠르게 고갈된다. - 운영체제의 리소스를 사용하므로<li>생성 및 소멸이 오래 걸린다. - 운영체제 수준의 관리작업이 필요하므로<li>I/O 작업을 만나면 블로킹 된다. - Interrupt 호출</ul><p>그러므로, <code class="language-plaintext highlighter-rouge">스레드를 무제한 생성하지 않기 위해</code> + <code class="language-plaintext highlighter-rouge">계속 생성 및 삭제</code> 하지 않기 위해 스레드 풀이 필요하게 된다.</p><h2 id="스레드---스레드-풀"><span class="me-2">스레드 - 스레드 풀</span><a href="#스레드---스레드-풀" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>스레드 풀(Pool)은 정말 말 그대로 스레드 연못이다. 스레드를 미리 생성해두고, 사용할때 하나씩 꺼내 사용하게 해준다. 자바에서는 스레드 풀을 어떻게 동작시킬까?</p><blockquote><p><code class="language-plaintext highlighter-rouge">ThreadPoolExecutor</code> 과 <code class="language-plaintext highlighter-rouge">AbstractExecutorService</code> 를 기반으로 설명한다.</p></blockquote><p>스레드 풀은 아래 단계로 동작한다.</p><ol><li>Task Submitter 가 작업을 Thread Pool 에 전달한다. - AbstractExecutorService.submit<li>전달받은 작업은 Thread Pool 의 Queue 에 순차적 저장 - <code class="language-plaintext highlighter-rouge">workQueue.offer</code><li>유후 Thread 가 존재하면, Queue 에서 작업을 꺼내 처리한다. - <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor.getTask</code><li>만약 유후 Thread가 존재하지 않으면, Queue에서 처리할 때 까지 대기<li>작업 마친 Thread 는 Queue 에서 새로운 작업 도착할 때까지 대기</ol><p>코드로 좀 더 살펴보자.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">// AbstractExecutorService.submit</span>

<span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">submit</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">,</span> <span class="no">T</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NullPointerException</span><span class="o">();</span>  
    <span class="nc">RunnableFuture</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">ftask</span> <span class="o">=</span> <span class="n">newTaskFor</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>  
    <span class="n">execute</span><span class="o">(</span><span class="n">ftask</span><span class="o">);</span>  
    <span class="k">return</span> <span class="n">ftask</span><span class="o">;</span>  
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">// ThreadPoolExecutor.execute</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>  
    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
	<span class="k">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span><span class="o">)</span> <span class="o">{</span>  
	    <span class="k">if</span> <span class="o">(</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span>  
	        <span class="k">return</span><span class="o">;</span>  
	    <span class="n">c</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
	<span class="o">}</span>
	
	<span class="k">if</span> <span class="o">(</span><span class="n">isRunning</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">workQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">command</span><span class="o">))</span> <span class="o">{</span>  
	    <span class="kt">int</span> <span class="n">recheck</span> <span class="o">=</span> <span class="n">ctl</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>  
	    <span class="k">if</span> <span class="o">(!</span> <span class="n">isRunning</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">remove</span><span class="o">(</span><span class="n">command</span><span class="o">))</span>  
	        <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>  
	    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">workerCountOf</span><span class="o">(</span><span class="n">recheck</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>  
	        <span class="n">addWorker</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>  
	<span class="o">}</span>  
	<span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="n">addWorker</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>  
	    <span class="n">reject</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li><p>워커 스레드 개수가 코어보다 작다면? -&gt; 워커스레드를 추가한다.</p><li><p>현재 스레드풀이<code class="language-plaintext highlighter-rouge">RUNNING</code> 이며 &amp;&amp; 작업대기열에 제공이 성공했다면? -&gt; 다시 확인결과, <code class="language-plaintext highlighter-rouge">RUNNING</code> 이 아니며 &amp;&amp; 작업 대기열 제거가 성공하면? - 거절한다. -&gt; 워커스레드 개수가 0이라면? - 워커스레드 추가한다.</p><li><p>워커스레드 추가를 실패하면? - 거절한다.</p></ul><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">// ThreadPoolExecutor.addWorker</span>

<span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">addWorker</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">firstTask</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">core</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">Worker</span> <span class="n">w</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>  
	<span class="k">try</span> <span class="o">{</span>  
	    <span class="n">w</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="o">(</span><span class="n">firstTask</span><span class="o">);</span>  
	    <span class="kd">final</span> <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">thread</span><span class="o">;</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>  
		    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">mainLock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">mainLock</span><span class="o">;</span>  
		    <span class="n">mainLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
		    <span class="k">try</span> <span class="o">{</span>
			    <span class="o">...</span>
			    <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">);</span>  
				<span class="n">workerAdded</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>  
			    <span class="n">mainLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>  
			<span class="o">}</span>  
			<span class="k">if</span> <span class="o">(</span><span class="n">workerAdded</span><span class="o">)</span> <span class="o">{</span>  
			    <span class="n">t</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>  
			    <span class="n">workerStarted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>  
			<span class="o">}</span>
			<span class="o">...</span>
	<span class="k">return</span> <span class="n">workerStarted</span><span class="o">;</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre> <span class="c1">// ThreadPoolExecutor.Worker</span>
 
<span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Worker</span>  
    <span class="kd">extends</span> <span class="nc">AbstractQueuedSynchronizer</span>  
    <span class="kd">implements</span> <span class="nc">Runnable</span>  
<span class="o">{</span>
	<span class="nc">Worker</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">firstTask</span><span class="o">)</span> <span class="o">{</span>  
	    <span class="n">setState</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// inhibit interrupts until runWorker  </span>
	    <span class="k">this</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="n">firstTask</span><span class="o">;</span>  
	    <span class="k">this</span><span class="o">.</span><span class="na">thread</span> <span class="o">=</span> <span class="n">getThreadFactory</span><span class="o">().</span><span class="na">newThread</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  
	    <span class="n">runWorker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">;</span>
</pre></table></code></div></div><ol><li>ThreadFactory 에서 스레드를 생성해서 워커를 지정한다.<li><code class="language-plaintext highlighter-rouge">ReentrantLock</code> 을 통해 Lock 을 건다.<li>워커큐에 추가한다.<li>추가되면, 워커 스레드가 시작된다. - ( 1. <code class="language-plaintext highlighter-rouge">t.start()</code> 2. <code class="language-plaintext highlighter-rouge">Worker.run</code> 3. <code class="language-plaintext highlighter-rouge">ThreadPoolExecutor.runWorker</code> )</ol><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">// ThreadPoolExecutor.runWorker</span>
<span class="kd">final</span> <span class="kt">void</span> <span class="nf">runWorker</span><span class="o">(</span><span class="nc">Worker</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">wt</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="nc">Runnable</span> <span class="n">task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span><span class="o">;</span>
        <span class="n">w</span><span class="o">.</span><span class="na">firstTask</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span> <span class="c1">// allow interrupts</span>
        <span class="kt">boolean</span> <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">task</span> <span class="o">=</span> <span class="n">getTask</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
	            <span class="n">w</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">beforeExecute</span><span class="o">(</span><span class="n">wt</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                        <span class="n">afterExecute</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">afterExecute</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">completedTasks</span><span class="o">++;</span>
                    <span class="n">w</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">completedAbruptly</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">processWorkerExit</span><span class="o">(</span><span class="n">w</span><span class="o">,</span> <span class="n">completedAbruptly</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><p>태스크를 받아와 수행한다. <code class="language-plaintext highlighter-rouge">firstTask</code> 또는 <code class="language-plaintext highlighter-rouge">getTask()</code> 를 통해 작업을 가져와서 실행한다. (<code class="language-plaintext highlighter-rouge">getTask()</code> 부분은 Interface 형식으로 되어있다. ) 이렇게 스레드 풀이 계속해서 Task 를 가져와서 작업을 수행해주는 건 알겠다.</p><p>그러면, 스레드 풀을 사용하고 사용하지 않는 것은 얼마나 차이가 날까?</p><h2 id="스레드-풀-성능-비교"><span class="me-2">스레드 풀 성능 비교</span><a href="#스레드-풀-성능-비교" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>코드는 <a href="https://github.com/youngsu5582/curious-java-study/tree/6ff099cf4356816cb1c9bc9eb601d18d7b50769f/src/main/java/joyson/threadpool">이를</a> 참고한다. 작업들이 같이 묶여있어도 하나씩 직접 실행해서 측정을 했다. ( 매우 반복적인 노가다… )</p><blockquote><p>맥북에서 활성 상태 보기 - 프로세스 더블 클릭 - 통계 - 문맥 전환 을 통해 확인할 수 있다. ( Linux 에서는 <a href="https://kernel.bz/boardPost/118679/8">perf</a> 라는 도구가 있다. )</p></blockquote><blockquote><p>본인의 맥북은 m2 에어이며, 8코어이다. 메모리는 16GB - 성능 사양상 참고</p></blockquote><h3 id="cpu-intensive"><span class="me-2">CPU Intensive</span><a href="#cpu-intensive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">static</span> <span class="kd">class</span> <span class="nc">CpuMemoryIntensiveTask</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>  
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DATA_SIZE</span> <span class="o">=</span> <span class="mi">10_000</span><span class="o">;</span> <span class="c1">// 10KB 메모리  </span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ITERATIONS</span> <span class="o">=</span> <span class="mi">9000000</span><span class="o">;</span> <span class="c1">// 반복 횟수  </span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Random</span> <span class="no">RANDOM</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>

		<span class="nd">@Override</span>  
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>  
	    <span class="kt">int</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="no">DATA_SIZE</span><span class="o">];</span> <span class="c1">// 10KB 배열 생성  </span>
	  
	    <span class="c1">// 배열에 랜덤값 저장  </span>
	    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">DATA_SIZE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>  
	        <span class="n">data</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="no">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">();</span>  
	    <span class="o">}</span>  
	  
	    <span class="c1">// 랜덤 메모리 접근 작업  </span>
	    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>  
	        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="no">RANDOM</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="no">DATA_SIZE</span><span class="o">);</span>  
	        <span class="n">data</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">+</span> <span class="nc">Math</span><span class="o">.</span><span class="na">tan</span><span class="o">(</span><span class="n">data</span><span class="o">[</span><span class="n">index</span><span class="o">]));</span>  
	    <span class="o">}</span>  
	<span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>큰 메모리 + RANDOM ACCESS -&gt; 메모리 캐시를 계속 지워야 한다. -&gt; CPU 작업량이 증가한다.</p><p>이로 인해 우리는 CPU Intensive 한 작업일 때 성능 비교를 할 수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>runWithThreadPool(4, 10); // 스레드 풀 사용  
runWithoutThreadPool(10); // 스레드 풀 없이 직접 생성

Execution Time (ThreadPool): 7799 ms
Execution Time (Without ThreadPool): 19487 ms
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Execution Time (ThreadPool): 15250 ms
Execution Time (Without ThreadPool): 32587 ms
</pre></table></code></div></div><p>스레드 풀없이 작업하는게 시간이 더 오래 걸린다.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>pool-1-thread-3 running start : taskId : 4time : 1736945552855
pool-1-thread-1 finished : taskId : 0time : 1736945552869
pool-1-thread-1 running start : taskId : 5time : 1736945552869
pool-1-thread-2 finished : taskId : 1time : 1736945552888
pool-1-thread-2 running start : taskId : 6time : 1736945552888
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Thread-4 running start : taskId : 4time : 1736945565048
Thread-5 running start : taskId : 5time : 1736945565048
Thread-6 running start : taskId : 6time : 1736945565048
Thread-7 running start : taskId : 7time : 1736945565051
Thread-8 running start : taskId : 8time : 1736945565060
Thread-9 running start : taskId : 9time : 1736945565078
...
</pre></table></code></div></div><p>스레드 풀 없이 동작하는 로직은 거의 동시에 시작했음에도 불구하고</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>...
Thread-7 finished : taskId : 7time : 1736945597620
Thread-17 finished : taskId : 17time : 1736945597622
Thread-1 finished : taskId : 1time : 1736945597629
Thread-16 finished : taskId : 16time : 1736945597633
</pre></table></code></div></div><p>종료시간이 고루지 않게 끝나는걸 볼 수 있다.</p><p>-&gt; 즉, 같이 작업이 실행되더라도 CPU 가 실행해주는 시간은 필연적으로 걸린다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용  </span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용  </span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용</span>

<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">22479</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">70021</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">68767</span> <span class="n">ms</span>

</pre></table></code></div></div><p>그러면, 위에서 말한 내용처럼 정말 스레드 풀 내 개수가 늘어나도 시간이 줄어들지 않는지 확인하자.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용  </span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용  </span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mi">30</span><span class="o">);</span> <span class="c1">// 스레드 풀 사용</span>

<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">22479</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">70021</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">68767</span> <span class="n">ms</span>

<span class="o">...</span>

<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">22415</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">56424</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">54439</span> <span class="n">ms</span>
</pre></table></code></div></div><p>오히려, 시간이 상당히 늘어나는걸 볼 수 있다.</p><p>CPU Context Switching 은 얼마나 일어난지 측정해본 결과</p><p><code class="language-plaintext highlighter-rouge">runWithThreadPool(4, 30)</code> 은 18,439번 <code class="language-plaintext highlighter-rouge">runWithThreadPool(8, 30)</code> 은 410,752번 <code class="language-plaintext highlighter-rouge">runWithoutThreadPool(20)</code> 은 401,040번</p><p>이 발생했다.</p><p>-&gt; 이를 통해 잘못된 설정이 얼마나 성능 저하를 불러일으키는지 알 수 있었다.</p><h3 id="파일-io"><span class="me-2">파일 IO</span><a href="#파일-io" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>파일을 생성하고, 연결해서 내용을 작성해 IO 작업을 구현했다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">try</span> <span class="o">(</span><span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">fileName</span><span class="o">)))</span> <span class="o">{</span>  
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span> <span class="c1">// 파일에 10000줄 쓰기  </span>
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"Task "</span> <span class="o">+</span> <span class="n">taskId</span> <span class="o">+</span> <span class="s">" - Line "</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>  
    <span class="o">}</span>  
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>버퍼가 꽉차면, 파일에 flush 를 자동으로 날린다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">taskCount</span> <span class="o">=</span> <span class="mi">2000</span><span class="o">;</span>  
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="n">taskCount</span><span class="o">);</span>  
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">taskCount</span><span class="o">);</span>  
<span class="n">runWithoutThreadPool</span><span class="o">(</span><span class="n">taskCount</span><span class="o">);</span>

<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">3821</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">10966</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">Without</span> <span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">14274</span> <span class="n">ms</span>
</pre></table></code></div></div><p><a href="https://i.imgur.com/G8fP1s5.png" class="popup img-link shimmer"><img src="https://i.imgur.com/G8fP1s5.png" alt="" loading="lazy"></a></p><p>당연하게도. 스레드 생성 소멸이 처리되지 않으므로 스레드 풀이 더 효율적으로 나온다.</p><p>그리고, CPU 시간도 매우 적게 사용한다.</p><h3 id="네트워크-io"><span class="me-2">네트워크 IO</span><a href="#네트워크-io" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>파일 IO 는 알겠고 네트워크 IO 는? 두가지로 접근해볼텐데 ( 요청이 빨리 끝나는, 요청이 늦게 끝나는 )</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="no">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="no">URL</span><span class="o">(</span><span class="n">urlStr</span><span class="o">);</span>  
<span class="nc">HttpURLConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">(</span><span class="nc">HttpURLConnection</span><span class="o">)</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">();</span>  
<span class="n">connection</span><span class="o">.</span><span class="na">setRequestMethod</span><span class="o">(</span><span class="s">"GET"</span><span class="o">);</span>  
<span class="n">connection</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span> <span class="c1">// 연결 시간 초과 설정 (5초)  </span>
<span class="n">connection</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span> <span class="c1">// 읽기 시간 초과 설정 (5초)</span>
</pre></table></code></div></div><p>이렇게 네트워크 요청을 보낸다.</p><h4 id="빨리-끝나는-요청"><span class="me-2">빨리 끝나는 요청</span><a href="#빨리-끝나는-요청" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="c1">//final String urlStr = "https://jsonplaceholder.typicode.com/posts/1"; 요청</span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="n">taskCount</span><span class="o">);</span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="n">taskCount</span><span class="o">);</span>
<span class="n">runWithoutThreadPool</span><span class="o">(</span><span class="n">taskCount</span><span class="o">);</span>

<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">1150</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">774</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">Without</span> <span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">864</span> <span class="n">ms</span>
</pre></table></code></div></div><p><a href="https://i.imgur.com/BDmDTNQ.png" class="popup img-link shimmer"><img src="https://i.imgur.com/BDmDTNQ.png" alt="" loading="lazy"></a></p><p>네트워크 IO 역시도 CPU 는 시간도 매우 적게 받고, 컨텍스트 스위칭도 매우 적게 발생한다.</p><h4 id="느린-요청"><span class="me-2">느린 요청</span><a href="#느린-요청" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><code class="language-plaintext highlighter-rouge">https://httpbin.org/delay/2</code> 해당 경로에 요청을 보내서 처리한다. 해당 경로에 요청을 보내면 <code class="language-plaintext highlighter-rouge">delay/{number}</code> 만큼 대기를 한 후 다시 응답을 해준다.</p></blockquote><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">//final String urlStr = "https://httpbin.org/delay/2"; 요청</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">41596</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">6000</span> <span class="n">ms</span>
<span class="nc">Execution</span> <span class="nf">Time</span> <span class="o">(</span><span class="nc">Without</span> <span class="nc">ThreadPool</span><span class="o">):</span> <span class="mi">6445</span> <span class="n">ms</span>
</pre></table></code></div></div><p><a href="https://i.imgur.com/ick0Cm3.png" class="popup img-link shimmer"><img src="https://i.imgur.com/ick0Cm3.png" alt="" loading="lazy"></a></p><p>와 같은 결과가 나온다. 시간이 오래 걸려도, CPU 에 영향을 주는 부분은 없다.</p><p><a href="https://i.imgur.com/F94qVgV.png" class="popup img-link shimmer"><img src="https://i.imgur.com/F94qVgV.png" alt="" loading="lazy"></a></p><p>차지하는 힙 메모리는 각각 차이가 난다.</p><p>우리는 이를 통해 IO 작업은 힙 메모리와 처리량(throughput) 이 비례 관계임을 알 수 있다. 그리고, CPU Context Switching 이 비교적 적게 일어나는 사실 역시도 알 수 있다.</p><h3 id="oom"><span class="me-2">OOM</span><a href="#oom" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>그러면, 힙 메모리를 줄이기 위해 다소 실행 시간을 포기하고 스레드 풀 내 개수를 줄이면? 제목에서 볼 수 있듯이 이는 오히려 OOM 을 발생 시킬 수 있다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">taskCount</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="c1">// 작업 개수</span>
<span class="n">runWithThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">taskCount</span><span class="o">);</span>
</pre></table></code></div></div><p>의도적으로 스레드풀에 스레드를 하나만 만들고, 작업을 21억개를 넣으면?</p><p><a href="https://i.imgur.com/9YYuGKC.png" class="popup img-link shimmer"><img src="https://i.imgur.com/9YYuGKC.png" alt="" loading="lazy"></a></p><p>빠르게 메모리르 초과하고, CPU 시간 및 컨텍스트 스위칭도 어마어마하게 일어난다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">pool</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span> <span class="n">running</span> <span class="n">start</span> <span class="o">:</span> <span class="n">taskId</span> <span class="o">:</span> <span class="mi">6</span><span class="n">time</span> <span class="o">:</span> <span class="mi">1736990425896</span>
<span class="n">pool</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span> <span class="n">running</span> <span class="n">start</span> <span class="o">:</span> <span class="n">taskId</span> <span class="o">:</span> <span class="mi">7</span><span class="n">time</span> <span class="o">:</span> <span class="mi">1736990447620</span>

<span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">"main"</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="nc">Java</span> <span class="n">heap</span> <span class="n">space</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">base</span><span class="o">/</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">LinkedBlockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="nc">LinkedBlockingQueue</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">409</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">base</span><span class="o">/</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">ThreadPoolExecutor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">1357</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">base</span><span class="o">/</span><span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">concurrent</span><span class="o">.</span><span class="na">AbstractExecutorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="nc">AbstractExecutorService</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">123</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">joyson</span><span class="o">.</span><span class="na">threadpool</span><span class="o">.</span><span class="na">ThreadPoolDiffInNetworkIOIntensive</span><span class="o">.</span><span class="na">runWithThreadPool</span><span class="o">(</span><span class="nc">ThreadPoolDiffInNetworkIOIntensive</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">29</span><span class="o">)</span>
	<span class="n">at</span> <span class="n">joyson</span><span class="o">.</span><span class="na">threadpool</span><span class="o">.</span><span class="na">ThreadPoolDiffInNetworkIOIntensive</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="nc">ThreadPoolDiffInNetworkIOIntensive</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">16</span><span class="o">)</span>
	
<span class="n">pool</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span> <span class="n">running</span> <span class="n">start</span> <span class="o">:</span> <span class="n">taskId</span> <span class="o">:</span> <span class="mi">8</span><span class="n">time</span> <span class="o">:</span> <span class="mi">1736990480824</span>
<span class="n">pool</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">thread</span><span class="o">-</span><span class="mi">1</span> <span class="n">running</span> <span class="n">start</span> <span class="o">:</span> <span class="n">taskId</span> <span class="o">:</span> <span class="mi">9</span><span class="n">time</span> <span class="o">:</span> <span class="mi">1736990483422</span>
</pre></table></code></div></div><p>코드에서도 OOM 이 발생한다. 이때, 흥미로운 점은 OOM 이 발생해도 스레드 작업은 일어난다는 것이다. ( 찾아보니, OFFER 부분에서 OOM 이 터져도, 다른 스레드는 작업을 처리한다. )</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

<span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>  
                                  <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>  
                                  <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span>  
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">LinkedBlockingQueue</span><span class="o">()</span> <span class="o">{</span>  
    <span class="k">this</span><span class="o">(</span><span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>기본적인 LInkedBlockingQueue 는 대기열을 <code class="language-plaintext highlighter-rouge">INTEGER.MAX_VALUE</code> 까지 받는다. 작업은 무제한으로 계속 Queue 에 추가되어 메모리르 치자한다.</p><p>그러므로, 스레드 개수를 조절해서 빠르게 처리되게 하거나 or 큐의 대기열 개수를 조절을 해야한다. 추가로, 큐가 다차면 요청을 어떻게 거절 및 처리할지에 대해서도 정할 수 있다. - <code class="language-plaintext highlighter-rouge">rejecetedExceptionHandler</code></p><p>이 부분에 대해선 우테코를 다니며 미션 중 정리한 내용이 있어서 갈음한다. - <a href="https://github.com/woowacourse/java-http/pull/760#discussion_r1765201226">미션 중 정리 링크</a></p><h3 id="결론"><span class="me-2">결론</span><a href="#결론" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li>스레드 풀을 사용하지 않고, 스레드만 사용하는 경우는 대부분 성능상 더 안 좋다. ( System Call 작업 + 생성 &amp; 소멸 )<li>CPU 작업은 스레드가 많아지는게 오히려 더 안좋다. ( Context Switching )<li>IO 작업은 스레드가 많아져도 상관이 없다. ( 대부분이 Interrupt 를 받을 때 까지 <code class="language-plaintext highlighter-rouge">WAITING</code> )<li>스레드 풀 스레드 개수는 힙 메모리 용량과 비례한다.<li>스레드 풀의 스레드 개수와 대기열은 적절하게 정해져야 한다.</ol><p>그러면, 이제 대망의 <code class="language-plaintext highlighter-rouge">왜 여러개의 스레드 풀이 필요할까??</code> 에 다뤄보자.</p><h2 id="왜-여러개의-스레드-풀이-필요한가"><span class="me-2">왜 여러개의 스레드 풀이 필요한가?</span><a href="#왜-여러개의-스레드-풀이-필요한가" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>찾아봤는데 이 부분에 대한 검색 내용이 매우 없었다. 그래서, 직접 해서 나온 결과를 기반으로 설명한다.</p><h3 id="성능-저하"><span class="me-2">성능 저하</span><a href="#성능-저하" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>그러면, 우리가 기존에 확인했던 CPU,파일 IO,네트워크 IO 작업들을 한 스레드 풀 VS 여러 스레드 풀로 나뉘어서 성능을 확인해보자.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">taskCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>  
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">taskId</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>  
  
    <span class="k">if</span> <span class="o">(</span><span class="n">taskId</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>  
                <span class="n">measureTaskLog</span><span class="o">(</span><span class="s">"FileIO Task-"</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">taskId</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">performIO</span><span class="o">(</span><span class="n">taskId</span><span class="o">))</span>  
        <span class="o">));</span>  
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">taskId</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>  
                <span class="n">measureTaskLog</span><span class="o">(</span><span class="s">"NetworkIO Task-"</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">taskId</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">performNetworkIO</span><span class="o">(</span><span class="n">taskId</span><span class="o">))</span>  
        <span class="o">));</span>  
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>  
        <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span>  
                <span class="n">measureTaskLog</span><span class="o">(</span><span class="s">"CPU Task-"</span> <span class="o">+</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">taskId</span><span class="o">,</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">performCPU</span><span class="o">(</span><span class="n">taskId</span><span class="o">))</span>  
        <span class="o">));</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>작업이 하나의 유형만 들어가는게 아니라 골고루 들어가게 했다. ( 여러개의 스레드 풀에선 <code class="language-plaintext highlighter-rouge">threadPool</code> 통일이 아니라, <code class="language-plaintext highlighter-rouge">networkPool</code>,<code class="language-plaintext highlighter-rouge">cpuPool</code>,<code class="language-plaintext highlighter-rouge">fileIOPool</code> 과 같이 들어간다. )</p><p>되게, 복잡해서 이는 직접 측정이 아니라 자바에서 제공해주는 걸로 테스트한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>  
<span class="kd">final</span> <span class="kt">long</span> <span class="n">threadCpuStartTime</span> <span class="o">=</span> <span class="n">cpuTimeSupported</span> <span class="o">?</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getCurrentThreadCpuTime</span><span class="o">()</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>  
  
<span class="n">performCPU</span><span class="o">(</span><span class="n">taskId</span><span class="o">);</span>  
  
<span class="kd">final</span> <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>  
<span class="kd">final</span> <span class="kt">long</span> <span class="n">threadCpuEndTime</span> <span class="o">=</span> <span class="n">cpuTimeSupported</span> <span class="o">?</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getCurrentThreadCpuTime</span><span class="o">()</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>  
  
<span class="kd">final</span> <span class="kt">long</span> <span class="n">cpuTimeUsed</span> <span class="o">=</span> <span class="o">(</span><span class="n">threadCpuStartTime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">threadCpuEndTime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>  
        <span class="o">?</span> <span class="o">(</span><span class="n">threadCpuEndTime</span> <span class="o">-</span> <span class="n">threadCpuStartTime</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1_000_000</span>  
        <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">final</span> <span class="nc">ThreadMXBean</span> <span class="n">threadMXBean</span> <span class="o">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getThreadMXBean</span><span class="o">();</span>
</pre></table></code></div></div><p>threadMXBean 을 통해 현재 스레드가 얼마나 CPU Time 을 받았는지 측정한다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">saveDataToFile</span><span class="o">(</span><span class="kd">final</span> <span class="nc">String</span> <span class="n">filename</span><span class="o">,</span> <span class="kd">final</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">TaskLog</span><span class="o">&gt;</span> <span class="n">logs</span><span class="o">)</span> <span class="o">{</span>  
    <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileWriter</span><span class="o">(</span><span class="n">filename</span><span class="o">)))</span> <span class="o">{</span>  
        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="s">"TaskID,Thread,Type,StartTime,EndTime,ExecutionTime,CPUTime(ms)\n"</span><span class="o">);</span> <span class="c1">// CSV 헤더  </span>
        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">TaskLog</span> <span class="n">log</span> <span class="o">:</span> <span class="n">logs</span><span class="o">)</span> <span class="o">{</span>  
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">toCsv</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>  
        <span class="o">}</span>  
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="kd">final</span> <span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>  
    <span class="o">}</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>그 후, 이렇게 CSV 에 작성해서 비교한다. 먼저, 여러개의 스레드 풀 부터 살펴보면?</p><h3 id="여러개-스레드-풀"><span class="me-2">여러개 스레드 풀</span><a href="#여러개-스레드-풀" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Multiple Thread Pools Time Taken: 25811ms
</pre></table></code></div></div><blockquote><p>CSV 형식이라 보기 어려울 수 있으므로 앞부분만 캡처해서 보여준다.</p></blockquote><p><a href="https://i.imgur.com/mMqfZ4M.png" class="popup img-link shimmer"><img src="https://i.imgur.com/mMqfZ4M.png" alt="" loading="lazy"></a></p><p>스레드풀이 작업을 순차적으로 받아서 스레드에게 할당을 하며 CPU 작업도 빠른 시간내 끝나는 것을 볼 수 있다. ( 오래 걸리는거 아닌가? 라고 생각하는데 밑을 보면 달라진다. ) 네트워크 IO 는 네트워크의 문제도 존재하는 것 같다. 🥲</p><h3 id="단일-스레드-풀"><span class="me-2">단일 스레드 풀</span><a href="#단일-스레드-풀" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Single Thread Pool Time Taken: 30783ms
</pre></table></code></div></div><p>싫행시간은 대략 5초가 차이가 났다.</p><p><a href="https://i.imgur.com/bRpBkKN.png" class="popup img-link shimmer"><img src="https://i.imgur.com/bRpBkKN.png" alt="" loading="lazy"></a></p><p>각 요청들은 여러 스레드 풀에 의해 시작하고 종료까지 매우 시간이 오래 걸린다. 작업을 수행하는데 걸리는 시간 + CPU 에 타임 슬롯을 할당받는 시간을 생가하면 정말정말 오래 걸린다.</p><h2 id="심층-분석"><span class="me-2">심층 분석</span><a href="#심층-분석" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>GPT 의 도움을 받아 ( 사실 그냥 Map 으로 만들어준게 다임 )</p><ul><li>Task 유형별 평균 CPUTime<li>Task별 CPUTime 분포<li>Thread별 CPUTime 분포</ul><p>로 측정을 해본다.</p><h3 id="멀티-스레드"><span class="me-2">멀티 스레드</span><a href="#멀티-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">===</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nc">Time</span> <span class="n">by</span> <span class="nc">Task</span> <span class="nc">Type</span> <span class="o">===</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">3.57</span> <span class="n">ms</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">1012.72</span> <span class="n">ms</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">2.05</span> <span class="n">ms</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nl">TaskID:</span> <span class="mi">248</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1068</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">119</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1058</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">242</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1056</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">53</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1055</span> <span class="n">ms</span>
<span class="o">...</span>
<span class="nl">TaskID:</span> <span class="mi">125</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">951</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">194</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">935</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">4</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">14</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">7</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">14</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">22</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">13</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">43</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">12</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">199</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">4</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">283</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">4</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">30</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">36</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">42</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">3</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">45</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">3</span> <span class="n">ms</span>
</pre></table></code></div></div><p>각 작업별 최대 ~ 최소 시간도 비교적 균일하다.</p><h3 id="싱글-스레드"><span class="me-2">싱글 스레드</span><a href="#싱글-스레드" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="o">===</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nc">Time</span> <span class="n">by</span> <span class="nc">Task</span> <span class="nc">Type</span> <span class="o">===</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">26.60</span> <span class="n">ms</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">1049.45</span> <span class="n">ms</span>
<span class="nc">Task</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="nc">Average</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mf">3.28</span> <span class="n">ms</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nl">TaskID:</span> <span class="mi">419</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1172</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">416</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1169</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">53</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1162</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">365</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">1151</span> <span class="n">ms</span>
<span class="o">...</span>
<span class="nl">TaskID:</span> <span class="mi">125</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">978</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">497</span><span class="o">,</span> <span class="nl">Type:</span> <span class="no">CPU</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">958</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">4</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">185</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">91</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">82</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">3</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">42</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">346</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">40</span> <span class="n">ms</span>
<span class="o">...</span>
<span class="nl">TaskID:</span> <span class="mi">55</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">14</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">85</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">14</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">343</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">NetworkIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">14</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">12</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">13</span> <span class="n">ms</span>
<span class="nl">TaskID:</span> <span class="mi">18</span><span class="o">,</span> <span class="nl">Type:</span> <span class="nc">FileIO</span> <span class="nc">Task</span><span class="o">,</span> <span class="no">CPU</span> <span class="nl">Time:</span> <span class="mi">13</span> <span class="n">ms</span>
</pre></table></code></div></div><p>평균적으로 시간이 스레드 풀 여러개 보다 더 발생했으며 IO 작업에서 특히 최대와 최소 시간 차이가 큰 것을 볼 수 있다. ( CPU Context Switching 이 많이 일어나서라고 생각 )</p><h3 id="task-혼용"><span class="me-2">Task 혼용</span><a href="#task-혼용" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I/O 는 CPU 를 받지 않으니까 상관 없는거 아니야? 하지만, 스레드가 그 동안 대기를 한다.</p><p><code class="language-plaintext highlighter-rouge">I/O 성 작업</code>, <code class="language-plaintext highlighter-rouge">CPU 성 작업</code>이 같이 있게 되면 I/O 작업을 수행하고 있는 스레드들이 대기한다. -&gt; CPU 성 작업은 스레드를 할당받아 0.01 초만 수행을 하게 되더라도 할당받기 전까지 대기하게 된다. =&gt; 위에서 본 것처럼 OOM 을 유발시킬 수 있다.</p><h3 id="데드락-발생-가능성"><span class="me-2">데드락 발생 가능성</span><a href="#데드락-발생-가능성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>이 부분은 DB Connection Pool DeadLock 과 동일하다. 일반적으로, 스레드 풀의 개수를 크게 하므로 문제가 발생할 것 같진 않지만 가능하다.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>  
<span class="k">try</span> <span class="o">{</span>  
    <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">parentFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
        <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">childFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
            <span class="k">try</span> <span class="o">{</span>  
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span> <span class="c1">// 작업 시뮬레이션  </span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>  
                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>  
            <span class="o">}</span>  
        <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>  
  
        <span class="n">childFuture</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// 자식 작업 완료를 기다림  </span>
    <span class="o">},</span> <span class="n">executor</span><span class="o">);</span>  
    <span class="n">parentFuture</span><span class="o">.</span><span class="na">join</span><span class="o">();</span> <span class="c1">// 부모 작업 완료를 기다림  </span>
<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>  
    <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>  
<span class="o">}</span>
</pre></table></code></div></div><p>또는</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">9</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>  
    <span class="kd">final</span> <span class="kt">int</span> <span class="n">parentId</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>  
    <span class="n">parentFutures</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>  
        <span class="k">try</span> <span class="o">{</span>  
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Void</span><span class="o">&gt;</span> <span class="n">childFuture</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">runAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
	        <span class="c1">// 나머지 동일</span>
			<span class="o">...</span>
</pre></table></code></div></div><p>하나의 로직에서 스레드 풀이 9개인데, 스레드 9개를 생생해 추가적인 작업을 하면?</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed=""><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>pool-1-thread-6 - Parent Task 5 started
pool-1-thread-7 - Parent Task 6 started
pool-1-thread-8 - Parent Task 7 started
pool-1-thread-1 - Parent Task 0 started
pool-1-thread-2 - Parent Task 1 started
pool-1-thread-5 - Parent Task 4 started
pool-1-thread-3 - Parent Task 2 started
pool-1-thread-9 - Parent Task 8 started
pool-1-thread-4 - Parent Task 3 started
</pre></table></code></div></div><p>이와같이 시작되고, 스레드 개수가 없어서 데드락 상태에 걸린다.</p><h2 id="결론-1"><span class="me-2">결론</span><a href="#결론-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li>일단 무조건 적으로, 성능상 차이가 난다. - 작업 간 리소스 분리해 간섭 제거<li>IO 가 처리해야 하는 스레드를 차지한다. - 다른 작업들이 계속 대기한다<li>데드락이 발생할 가능성이 있다. - 작업 간 의존성이 있는 작업이 계속 대기할 수 있다</ul><p>핵심은 <code class="language-plaintext highlighter-rouge">getTask</code> 를 통해 태스크를 받고, <code class="language-plaintext highlighter-rouge">Worker</code> 스레드를 할당 받아야 O.S 가 CPU 를 할당해준다 임을 명심하자. ( 하나의 스레드 풀은 태스크가 혼용되어 있어서 정체된다. )</p><blockquote><h3 id="비유-단일-고속도로-vs-작업별-전용-차선---by-gpt"><span class="me-2"><strong>비유: 단일 고속도로 vs. 작업별 전용 차선</strong> - By GPT</span><a href="#비유-단일-고속도로-vs-작업별-전용-차선---by-gpt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></blockquote><blockquote><ul><li><strong>단일 스레드 풀</strong>: 하나의 고속도로에 여러 종류의 차량(트럭, 버스, 오토바이)이 함께 운행.<ul><li>트럭(Network IO 작업)이 느리게 움직이면 뒤따르는 차량(CPU 작업)이 지연됨.</ul><li><strong>여러 스레드 풀</strong>: 작업 유형별로 전용 차선을 가진 고속도로.<ul><li>트럭은 느리게 가도 CPU 작업은 영향을 받지 않고 별도 차선에서 독립적으로 운행.</ul></ul></blockquote><p>긴 글이 끝났다. 토스뱅크 면접을 보며 매우 허점이 찔린 질문이였다. <code class="language-plaintext highlighter-rouge">왜 하나의 스레드풀 보다 여러개의 스레드풀이 성능이 더 좋다고 생각한건가요?</code> 단순, 기술이 아닌 기술에 내재된 C.S 를 알아나가도록 노력하자.</p></div><div class="post-tail-wrapper text-muted"><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"></div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted"></span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%EC%8A%A4%EB%A0%88%EB%93%9C,%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80%20in%20Java%20-%20%EC%9D%B4%EC%98%81%EC%88%98%20%EA%B0%9C%EB%B0%9C%20%EB%B8%94%EB%A1%9C%EA%B7%B8&url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2F%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25ED%2592%2580-in-Java%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2F%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25ED%2592%2580-in-Java%2F&text=%EC%8A%A4%EB%A0%88%EB%93%9C,%EC%8A%A4%EB%A0%88%EB%93%9C%ED%92%80%20in%20Java%20-%20%EC%9D%B4%EC%98%81%EC%88%98%20%EA%B0%9C%EB%B0%9C%20%EB%B8%94%EB%A1%9C%EA%B7%B8" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fyoungsu5582.life%2F%2Fposts%2F%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25EC%258A%25A4%25EB%25A0%2588%25EB%2593%259C%25ED%2592%2580-in-Java%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="" data-title-succeed="" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading"></h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/partitioning-in-postgresql/">파티셔닝 톺아보기 in PostgreSQL - 2025-09-07</a><li class="text-truncate lh-lg"> <a href="/posts/ai-tech-usage-summary-thoughts-ko/">개발자라면 꼭 알아야 할 AI 기술 활용법 영상 정리 및 간단한 사담 - 2025-08-20</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-Jackson-%EC%84%A4%EC%A0%95%EB%93%A4-%EC%A0%95%EB%A6%AC/">사용하는 Jackson의 설정 및 기능 정리 - 2025-06-17</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%98%88%EC%99%B8-%EA%B9%8A%EA%B2%8C-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0-%EC%98%88%EC%99%B8-%EB%8F%99%EC%A0%81%EC%9C%BC%EB%A1%9C-%EB%8D%98%EC%A7%80%EA%B8%B0/">예외 깊게 살펴보기, 예외 동적으로 던지기 - 2025-05-31</a><li class="text-truncate lh-lg"> <a href="/posts/%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-ENUM-%EA%B0%92-%EB%8C%80%EC%9D%91,Interface-%ED%86%B5%ED%95%9C-%EC%A4%91%EB%B3%B5-%EC%BD%94%EB%93%9C-%EC%A0%9C%EA%B1%B0/">사용하지 않는 ENUM 값 대응 , Interface 를 통한 중복 코드 제거 - 2025-05-26</a></ul></section><section><h2 class="panel-heading"></h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9A%B0%ED%85%8C%EC%BD%94/">우테코</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81/">스프링</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%9A%8C%EA%B3%A0/">회고</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83%ED%97%88%EB%B8%8C/">깃허브</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9E%90%EB%B0%94/">자바</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83/">깃</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%BD%94%ED%8B%80%EB%A6%B0/">코틀린</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%85%8C%EC%8A%A4%ED%8A%B8/">테스트</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0"></h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label"></h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/Jsoup-%EA%B3%BC-%ED%81%AC%EB%A1%A4%EB%A7%81-%ED%8C%81/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1736478557" data-df="DD/MM/YYYY" > 10/01/2025 </time><h4 class="pt-0 my-2">Jsoup 과 크롤링 팁</h4><div class="text-muted"><p>크롤링은 Selenium 으로 하는거 아닌가요?</p></div></div></a></article><article class="col"> <a href="/posts/%EC%95%8C%EC%95%84%EB%8F%84-%EC%A0%95%EB%A7%90-%EC%93%B8%EB%8D%B0%EC%97%86%EB%8A%94-%EC%9E%90%EB%B0%94-%EC%9E%A1%ED%95%99%EC%82%AC%EC%A0%84-with-JOL/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1732082090" data-df="DD/MM/YYYY" > 20/11/2024 </time><h4 class="pt-0 my-2">알아도 정말 쓸데없는 자바 잡학사전 with JOL</h4><div class="text-muted"><p>알아도 하나도 정말 쓸데없음 주의</p></div></div></a></article><article class="col"> <a href="/posts/%EC%9E%90%EB%B0%94-%EB%A6%AC%ED%94%8C%EB%A0%89%EC%85%98-%EC%96%B4%EB%94%94-%EA%B9%8C%EC%A7%80-%EA%B0%80%EB%8A%A5%ED%95%A0%EA%B9%8C/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1723734765" data-df="DD/MM/YYYY" > 16/08/2024 </time><h4 class="pt-0 my-2">자바 리플렉션 어디 까지 가능할까</h4><div class="text-muted"><p>PR 올리기 전 내 모든 메소드가 쿼리를 몇 번 실행 하는지 검사 & 리포트를 가능하게</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/Jsoup-%EA%B3%BC-%ED%81%AC%EB%A1%A4%EB%A7%81-%ED%8C%81/" class="btn btn-outline-primary" aria-label="" ><p>Jsoup 과 크롤링 팁</p></a> <a href="/posts/%EC%BD%94%ED%8B%80%EB%A6%B0-DSL-%EC%9D%84-%ED%99%9C%EC%9A%A9%ED%95%B4-RestDocs-%ED%9A%A8%EC%9C%A8%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%9C%EC%84%A0%ED%95%98%EA%B8%B0-ver-10/" class="btn btn-outline-primary" aria-label="" ><p>코틀린 DSL 을 활용해 RestDocs 효율적으로 개선하기 ( ver 1.0 )</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://github.com/youngsu5582">이영수</a>.</p><p></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading"></h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9A%B0%ED%85%8C%EC%BD%94/">우테코</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%8A%A4%ED%94%84%EB%A7%81/">스프링</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%9A%8C%EA%B3%A0/">회고</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83%ED%97%88%EB%B8%8C/">깃허브</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%9E%90%EB%B0%94/">자바</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/git/">git</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EA%B9%83/">깃</a> <a class="post-tag btn btn-outline-primary" href="/tags/%EC%BD%94%ED%8B%80%EB%A6%B0/">코틀린</a> <a class="post-tag btn btn-outline-primary" href="/tags/%ED%85%8C%EC%8A%A4%ED%8A%B8/">테스트</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><script> (function () { const themeMapper = Theme.getThemeMapper('light', 'dark_dimmed'); const initTheme = themeMapper[Theme.visualState]; let lang = 'ko';if (lang.length > 2 && !lang.startsWith('zh')) { lang = lang.slice(0, 2); } let giscusAttributes = { src: 'https://giscus.app/client.js', 'data-repo': 'youngsu5582/blog', 'data-repo-id': 'R_kgDOOI2eig', 'data-category': 'Post', 'data-category-id': 'DIC_kwDOOI2eis4Cob3Y', 'data-mapping': 'pathname', 'data-strict' : '0', 'data-reactions-enabled': '1', 'data-emit-metadata': '0', 'data-theme': initTheme, 'data-input-position': 'bottom', 'data-lang': lang, 'data-loading': 'lazy', crossorigin: 'anonymous', async: '' }; let giscusNode = document.createElement('script'); Object.entries(giscusAttributes).forEach(([key, value]) => giscusNode.setAttribute(key, value) ); const $footer = document.querySelector('footer'); $footer.insertAdjacentElement("beforebegin", giscusNode); addEventListener('message', (event) => { if (event.source === window && event.data && event.data.id === Theme.ID) { const newTheme = themeMapper[Theme.visualState]; const message = { setConfig: { theme: newTheme } }; const giscus = document.getElementsByClassName('giscus-frame')[0].contentWindow; giscus.postMessage({ giscus: message }, 'https://giscus.app'); } }); })(); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
