name: ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì¶œ

on:
  push:
    branches:
      - main
    paths:
      - '_posts/**/*.md'
      - 'en/_posts/**/*.md'
  pull_request:
    paths:
      - '_posts/**/*.md'
      - 'en/_posts/**/*.md'

jobs:
  check-backspace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬
        id: check
        run: |
          echo "ğŸ” ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì(\x08) ê²€ì‚¬ ì‹œì‘..."

          # ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìë¥¼ í¬í•¨í•œ íŒŒì¼ ì°¾ê¸°
          # -r: ì¬ê·€ ê²€ìƒ‰
          # -l: íŒŒì¼ ì´ë¦„ë§Œ ì¶œë ¥
          # -P: Perl ì •ê·œí‘œí˜„ì‹ ì‚¬ìš©
          # \x08: ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì

          FOUND_FILES=$(grep -rlP '\x08' _posts/ en/_posts/ 2>/dev/null || true)

          if [ -n "$FOUND_FILES" ]; then
            echo "âŒ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "=== ë¬¸ì œê°€ ìˆëŠ” íŒŒì¼ ëª©ë¡ ==="
            echo "$FOUND_FILES"
            echo ""

            # ê° íŒŒì¼ì˜ ìƒì„¸ ì •ë³´ ì¶œë ¥
            echo "=== ìƒì„¸ ì •ë³´ ==="
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo ""
                echo "ğŸ“„ íŒŒì¼: $file"
                # ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ìˆëŠ” ì¤„ ë²ˆí˜¸ì™€ ë‚´ìš© ì¶œë ¥
                grep -nP '\x08' "$file" | head -5 || true
              fi
            done <<< "$FOUND_FILES"

            # ê²°ê³¼ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥ (Slack ì•Œë¦¼ìš©)
            echo "has_backspace=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FOUND_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            exit 1
          else
            echo "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "has_backspace=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Send Slack Notification on Backspace Found
        if: failure() && steps.check.outputs.has_backspace == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âš ï¸ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "âš ï¸ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì¶œ" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë¬¸ì œ:* RSS Feed ë¹Œë“œì— ì‹¤íŒ¨í•  ìˆ˜ ìˆëŠ” ë°±ìŠ¤í˜ì´ìŠ¤(\\x08) ì œì–´ ë¬¸ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n*ì˜í–¥:* XML íŒŒì‹± ì—ëŸ¬ ë° RSS ìˆ˜ì§‘ ì‹¤íŒ¨ ê°€ëŠ¥ì„±"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë¬¸ì œ íŒŒì¼:*\n```${{ steps.check.outputs.files }}```"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*í•´ê²° ë°©ë²•:*\n1. í•´ë‹¹ íŒŒì¼ì„ ì—ë””í„°ë¡œ ì—½ë‹ˆë‹¤\n2. ë¬¸ì œê°€ ìˆëŠ” ê³µë°±ì„ Delete/Backspaceë¡œ ì™„ì „íˆ ì§€ì›ë‹ˆë‹¤\n3. ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ë‹¤ì‹œ ê³µë°±ì„ ì…ë ¥í•©ë‹ˆë‹¤\n4. ì €ì¥í•˜ê³  ì»¤ë°‹í•©ë‹ˆë‹¤"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Commit: <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>" },
                    { "type": "mrkdwn", "text": "ìì„¸í•œ ë¡œê·¸: <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|Workflow Run>" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send Slack Notification on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬ í†µê³¼",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬ í†µê³¼" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ëª¨ë“  í¬ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Commit: <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
