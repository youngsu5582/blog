name: ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì¶œ

on:
  push:
    branches:
      - main
    paths:
      - '_posts/**/*.md'
      - 'en/_posts/**/*.md'
  pull_request:
    paths:
      - '_posts/**/*.md'
      - 'en/_posts/**/*.md'

jobs:
  check-backspace:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬
        id: check
        run: |
          echo "ğŸ” ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì(\x08) ê²€ì‚¬ ì‹œì‘..."

          # ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìë¥¼ í¬í•¨í•œ íŒŒì¼ ì°¾ê¸°
          FOUND_FILES=$(grep -rlP '\x08' _posts/ en/_posts/ 2>/dev/null || true)

          if [ -n "$FOUND_FILES" ]; then
            echo "âŒ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "=== ë¬¸ì œê°€ ìˆëŠ” íŒŒì¼ ëª©ë¡ ==="
            echo "$FOUND_FILES"
            echo ""

            # Slackìš© ìƒì„¸ ì •ë³´ ìƒì„±
            DETAILS=""
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo "ğŸ“„ íŒŒì¼: $file"
                DETAILS+="ğŸ“„ *íŒŒì¼:* \`$file\`\n"

                # ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ìˆëŠ” ì¤„ ë²ˆí˜¸ì™€ ë‚´ìš© ì¶”ì¶œ
                while IFS=: read -r line_num line_content; do
                  # ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìë¥¼ [BS]ë¡œ í‘œì‹œ
                  visible_content=$(echo "$line_content" | sed 's/\x08/[BS]/g')
                  # ë„ˆë¬´ ê¸´ ì¤„ì€ 100ìë¡œ ì œí•œ
                  if [ ${#visible_content} -gt 100 ]; then
                    visible_content="${visible_content:0:100}..."
                  fi

                  echo "   Line $line_num: $visible_content"
                  DETAILS+="   â€¢ Line $line_num: \`$visible_content\`\n"
                done < <(grep -nP '\x08' "$file" | head -5)

                DETAILS+="\n"
              fi
            done <<< "$FOUND_FILES"

            # íŒŒì¼ ê°œìˆ˜ ì„¸ê¸°
            FILE_COUNT=$(echo "$FOUND_FILES" | wc -l)

            # ê²°ê³¼ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥ (Slack ì•Œë¦¼ìš©)
            echo "has_backspace=true" >> $GITHUB_OUTPUT
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            {
              echo "details<<EOF"
              echo -e "$DETAILS"
              echo "EOF"
            } >> $GITHUB_OUTPUT

            exit 1
          else
            echo "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "has_backspace=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Send Slack Notification on Backspace Found
        if: failure() && steps.check.outputs.has_backspace == 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âš ï¸ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ${{ steps.check.outputs.file_count }}ê°œ íŒŒì¼ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "âš ï¸ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì¶œ" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”´ *ë¬¸ì œ ìš”ì•½*\nRSS Feed ë¹Œë“œì— ì‹¤íŒ¨í•  ìˆ˜ ìˆëŠ” ë°±ìŠ¤í˜ì´ìŠ¤(`\\x08`) ì œì–´ ë¬¸ìê°€ *${{ steps.check.outputs.file_count }}ê°œ íŒŒì¼*ì—ì„œ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ“‹ *ìƒì„¸ ì •ë³´*\n\n${{ steps.check.outputs.details }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ› ï¸ *í•´ê²° ë°©ë²•*\n1. í•´ë‹¹ íŒŒì¼ì„ ì—ë””í„°ë¡œ ì—½ë‹ˆë‹¤\n2. í‘œì‹œëœ ë¼ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤\n3. `[BS]`ë¡œ í‘œì‹œëœ ìœ„ì¹˜ì˜ ê³µë°±ì„ Delete/Backspaceë¡œ ì™„ì „íˆ ì§€ì›ë‹ˆë‹¤\n4. ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ë‹¤ì‹œ ê³µë°±ì„ ì…ë ¥í•©ë‹ˆë‹¤\n5. ì €ì¥í•˜ê³  ì»¤ë°‹í•©ë‹ˆë‹¤"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "âš ï¸ *ì˜í–¥*\nâ€¢ XML íŒŒì‹± ì—ëŸ¬\nâ€¢ RSS ìˆ˜ì§‘ ì‹¤íŒ¨\nâ€¢ `<span class=\"err\"></span>` íƒœê·¸ ìƒì„±"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Commit: <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>" },
                    { "type": "mrkdwn", "text": "<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|ìƒì„¸ ë¡œê·¸ ë³´ê¸°>" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Send Slack Notification on Success
        if: success()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬ í†µê³¼",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "âœ… ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ì ê²€ì‚¬ í†µê³¼" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ëª¨ë“  í¬ìŠ¤íŠ¸ íŒŒì¼ì—ì„œ ë°±ìŠ¤í˜ì´ìŠ¤ ë¬¸ìê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    { "type": "mrkdwn", "text": "Commit: <https://github.com/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>" }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
